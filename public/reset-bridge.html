<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎšÏ‰Î´Î¹ÎºÎ¿Ï - ChefStack</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial;display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;padding:1rem}
    .card{background:#fff;padding:2rem;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.15);max-width:420px;width:100%}
    .logo{width:64px;height:64px;margin:0 auto 1rem;background:#F59E0B;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px}
    h2{margin:0 0 .5rem;text-align:center;color:#111}
    .subtitle{text-align:center;color:#666;font-size:.95rem;margin-bottom:1.5rem}
    label{display:block;font-size:.9rem;font-weight:500;color:#333;margin-bottom:.4rem}
    input{width:100%;padding:.7rem .9rem;border:1px solid #ddd;border-radius:6px;font-size:1rem;transition:border .2s}
    input:focus{outline:none;border-color:#F59E0B;box-shadow:0 0 0 3px rgba(245,158,11,0.1)}
    .field{margin-bottom:1.2rem}
    button{width:100%;padding:.8rem;background:#1e293b;color:#fff;border:none;border-radius:6px;font-size:1rem;font-weight:600;cursor:pointer;transition:opacity .2s}
    button:hover{opacity:.9}
    button:disabled{opacity:.5;cursor:not-allowed}
    .error{background:#fee;border:1px solid #fcc;color:#c33;padding:.7rem;border-radius:6px;margin-bottom:1rem;font-size:.9rem;text-align:center}
    .success{background:#efe;border:1px solid #cfc;color:#363;padding:.7rem;border-radius:6px;margin-bottom:1rem;font-size:.9rem;text-align:center}
    .spinner{display:inline-block;width:18px;height:18px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;margin-right:.5rem}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">ğŸ”</div>
    <h2>Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎšÏ‰Î´Î¹ÎºÎ¿Ï</h2>
    <p class="subtitle">Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ Î½Î­Î¿ ÏƒÎ±Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚</p>
    
    <div id="error" class="error" style="display:none"></div>
    <div id="success" class="success" style="display:none"></div>
    
    <form id="resetForm">
      <div class="field">
        <label for="password">ÎÎ­Î¿Ï‚ ÎšÏ‰Î´Î¹ÎºÏŒÏ‚</label>
        <input type="password" id="password" name="password" required minlength="6" autocomplete="new-password" />
      </div>
      <div class="field">
        <label for="confirmPassword">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· ÎšÏ‰Î´Î¹ÎºÎ¿Ï</label>
        <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6" autocomplete="new-password" />
      </div>
      <button type="submit" id="submitBtn">Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎšÏ‰Î´Î¹ÎºÎ¿Ï</button>
    </form>
  </div>

  <script>
    (function(){
      const form = document.getElementById('resetForm');
      const errorEl = document.getElementById('error');
      const successEl = document.getElementById('success');
      const submitBtn = document.getElementById('submitBtn');
      const passwordInput = document.getElementById('password');
      const confirmInput = document.getElementById('confirmPassword');

      function showError(msg){errorEl.textContent=msg;errorEl.style.display='block';successEl.style.display='none'}
      function showSuccess(msg){successEl.textContent=msg;successEl.style.display='block';errorEl.style.display='none'}
      function hideMessages(){errorEl.style.display='none';successEl.style.display='none'}

      // Extract token from the 'to' parameter (Supabase verify URL)
      const urlParams = new URLSearchParams(window.location.search);
      const toParam = urlParams.get('to');
      let accessToken = null;

      if(toParam){
        try{
          const decoded = decodeURIComponent(toParam);
          const verifyUrl = new URL(decoded);
          accessToken = verifyUrl.searchParams.get('token');
        }catch(e){console.error('Failed to extract token:',e)}
      }

      if(!accessToken){
        showError('ÎŸ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿Ï‚ ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬Ï‚ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ¿Ï‚ Î® Î­Ï‡ÎµÎ¹ Î»Î®Î¾ÎµÎ¹. Î Î±ÏÎ±ÎºÎ±Î»Ï Î¶Î·Ï„Î®ÏƒÏ„Îµ Î½Î­Î¿ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿.');
        submitBtn.disabled=true;
        return;
      }

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        hideMessages();
        const password = passwordInput.value;
        const confirm = confirmInput.value;

        if(password.length < 6){showError('ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 6 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚.');return}
        if(password !== confirm){showError('ÎŸÎ¹ ÎºÏ‰Î´Î¹ÎºÎ¿Î¯ Î´ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½.');return}

        submitBtn.disabled=true;
        submitBtn.innerHTML='<span class="spinner"></span>Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·...';

        try{
          // Call Supabase auth API directly with the token to update password
          const supabaseUrl = 'https://nbvghqsoftqhbdxpkpdl.supabase.co';
          const response = await fetch(`${supabaseUrl}/auth/v1/user`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`,
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5idmdocXNvZnRxaGJkeHBrcGRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NTY4NTAsImV4cCI6MjA1MjUzMjg1MH0.YlOnp0hQ6M2O2j-zNlNcqgG3uc9MoXJUwNnFuB-3_OE'
            },
            body: JSON.stringify({ password })
          });

          const data = await response.json();
          
          if(!response.ok){
            throw new Error(data.msg || data.error_description || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚ ÎºÏ‰Î´Î¹ÎºÎ¿Ï.');
          }

          showSuccess('ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚...');
          setTimeout(()=>window.location.href='https://www.chefstack.gr', 2000);
        }catch(err){
          showError(err.message || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚ ÎºÏ‰Î´Î¹ÎºÎ¿Ï. Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.');
          submitBtn.disabled=false;
          submitBtn.textContent='Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎšÏ‰Î´Î¹ÎºÎ¿Ï';
        }
      });
    })();
  </script>
</body>
</html>